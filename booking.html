<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Optimum — Booking</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--accent:#059669;--muted:#6b7280}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:#f8fafc;margin:0;padding:18px}
    .wrap{max-width:720px;margin:18px auto}
    .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    h2{margin-top:0}
    label{display:block;margin-top:10px;color:#111;font-weight:600}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;border:1px solid #e6eef0;border-radius:8px;font-size:15px;box-sizing:border-box}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:12px}
    .row > *{flex:1}
    .muted{color:var(--muted);font-size:13px;margin-top:8px}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .thumbs img{width:84px;height:64px;object-fit:cover;border-radius:6px;border:1px solid #e5e7eb}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;margin-top:12px;cursor:pointer;font-size:16px}
    .success{background:#d1fae5;border-left:4px solid #10b981;padding:10px;margin-top:10px}
    .error{background:#fee2e2;border-left:4px solid #ef4444;padding:10px;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Book an Electrician</h2>

      <form id="bookingForm">
        <label>Name</label>
        <input id="name" name="name" required/>

        <label>Phone</label>
        <input id="phone" name="phone" required/>

        <label>Locality</label>
        <select id="locality" name="locality" required>
          <option value="">Select locality</option>
          <option>Police Bazar</option>
          <option>Laitumkhrah</option>
          <option>Rilbong</option>
          <option>Other</option>
        </select>

        <label>Nearest Landmark</label>
        <input id="landmark" name="landmark"/>

        <label>Full Address</label>
        <textarea id="address" name="address" required></textarea>

        <label>Describe the problem</label>
        <textarea id="problem" name="problem" required></textarea>

        <div class="row">
          <div>
            <label>Convenient time</label>
            <input id="time" name="time" placeholder="e.g. Today 4pm - 6pm"/>
          </div>
          <div>
            <label>Alternate phone</label>
            <input id="altPhone" name="altPhone"/>
          </div>
        </div>

        <label>Upload pictures (optional)</label>
        <input id="pictures" type="file" accept="image/*" multiple />

        <div class="thumbs" id="thumbs"></div>

        <button id="submitBtn" type="button">Submit Booking</button>
      </form>

      <div id="message" class="muted"></div>
    </div>
  </div>

  <script>
    // ========== CONFIG ==========
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzcQtWaYWk53FtF8-RuWSGg7L4b5Kh3nPr0zq34VSwkpjtDTH8TeG-npvRsFq66dsO5xg/exec'; // <<----- paste your Apps Script Web App URL here

    // Prefill name & phone from index
    window.addEventListener('load', () => {
      const n = localStorage.getItem('opt_name'); if (n) document.getElementById('name').value = n;
      const p = localStorage.getItem('opt_phone'); if (p) document.getElementById('phone').value = p;
    });

    // Show previews & reduce size (resize)
    const picsInput = document.getElementById('pictures');
    const thumbs = document.getElementById('thumbs');
    let filesToUpload = []; // will hold objects: {name,mime,dataUrl}
    picsInput.addEventListener('change', async (e) => {
      thumbs.innerHTML = '';
      filesToUpload = [];
      const files = Array.from(e.target.files).slice(0,6); // limit 6 images
      for (const f of files) {
        const dataUrl = await resizeFileToDataURL(f, 1024, 0.7);
        filesToUpload.push({ name: f.name, mime: f.type, dataUrl });
        const img = document.createElement('img');
        img.src = dataUrl;
        thumbs.appendChild(img);
      }
    });

    // Resize helper (returns dataURL)
    function resizeFileToDataURL(file, maxWidth=1024, quality=0.7) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const img = new Image();
          img.onload = () => {
            let w = img.width; let h = img.height;
            if (w > maxWidth) { h = Math.round(h * (maxWidth / w)); w = maxWidth; }
            const canvas = document.createElement('canvas');
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const out = canvas.toDataURL(file.type || 'image/jpeg', quality);
            resolve(out);
          };
          img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Submit handler
    document.getElementById('submitBtn').addEventListener('click', async () => {
      const btn = document.getElementById('submitBtn');
      btn.disabled = true; btn.textContent = 'Sending...';
      document.getElementById('message').textContent = 'Submitting booking...';

      const payload = {
        name: document.getElementById('name').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        locality: document.getElementById('locality').value,
        landmark: document.getElementById('landmark').value.trim(),
        address: document.getElementById('address').value.trim(),
        problem: document.getElementById('problem').value.trim(),
        time: document.getElementById('time').value.trim(),
        altPhone: document.getElementById('altPhone').value.trim(),
        images: filesToUpload.map(f => ({ name: f.name, mime: f.mime, dataUrl: f.dataUrl })) // full dataURL
      };

      // Basic validation
      if (!payload.name || !payload.phone || !payload.address || !payload.problem) {
        alert('Please fill name, phone, address and problem.');
        btn.disabled = false; btn.textContent = 'Submit Booking';
        document.getElementById('message').textContent = '';
        return;
      }

      try {
        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        if (json && json.result === 'success') {
          document.getElementById('message').innerHTML = '<div class="success">Booking submitted — we will call you shortly.</div>';
          // keep name/phone
          localStorage.setItem('opt_name', payload.name);
          localStorage.setItem('opt_phone', payload.phone);
          document.getElementById('bookingForm').reset();
          thumbs.innerHTML = '';
          filesToUpload = [];
        } else {
          document.getElementById('message').innerHTML = '<div class="error">Failed to save booking. Try again.</div>';
        }
      } catch (err) {
        console.error(err);
        document.getElementById('message').innerHTML = '<div class="error">Error sending booking. Check the web app URL & deploy settings.</div>';
      } finally {
        btn.disabled = false; btn.textContent = 'Submit Booking';
      }
    });
  </script>
</body>
</html>
